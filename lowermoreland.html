<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Lower Moreland Stats</title>

  <!-- Bootstrap CSS (Flatly theme) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.6.2/flatly/bootstrap.min.css" />

  <style>
    table {
      width: 110%; /* table fills the centered box, not the whole page */
    }
  </style>
</head>
<body>

  <!-- Load header partial -->
  <div id="header"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => document.getElementById("header").innerHTML = html);
  </script>

  <!-- Load navbar partial -->
    <div id="navbar"></div>
    <script>
  fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      const navbarContainer = document.getElementById("navbar");
      navbarContainer.innerHTML = html;

      // Only show Opponents link if user is logged in
      if (sessionStorage.getItem("loggedIn") === "true") {
        const opponentsLink = document.getElementById("opponents-link");
        if (opponentsLink) {
          opponentsLink.style.display = "block";
        }
      }
    });
</script>

  <!-- Table + search wrapper -->
  <div id="table-wrapper" style="max-width: 1600px; margin: 0 auto; padding: 20px;">
    <!-- Search bar -->
    <input type="text" id="search" class="form-control mb-3" placeholder="Search table...">

    <!-- Table container -->
    <div id="table-container">
      Loading data...
    </div>
  </div>

  <!-- JS dependencies for Bootstrap 4 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>

  <!-- JS to fetch table data and handle search -->
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztsniDrMeK1GHDeE1q27omjL7L4nKOIkZSZpJrjl6EKVNMJJ1sfdWN10EiI47ZD3lB/exec";

    let tableData = [];
    let currentSortColumn = null;
    let sortDirection = {}; // true = ascending, false = descending

    // Fetch data
    fetch(SCRIPT_URL)
      .then(res => res.json())
      .then(data => {
        tableData = data;
        renderTable(tableData);
      })
      .catch(err => {
        document.getElementById("table-container").innerHTML = "Error loading data: " + err;
      });

    // Render table with sortable headers + arrows
    function renderTable(data) {
      if (!data || data.length === 0) {
        document.getElementById("table-container").innerHTML = "No data available.";
        return;
      }

      let html = "<table class='table table-bordered table-striped'><thead><tr>";

      Object.keys(data[0]).forEach((header, index) => {
        let arrow = "";
        if (currentSortColumn === index) {
          arrow = sortDirection[index] ? "▲" : "▼";
        }

        html += `<th style="cursor:pointer;" onclick="sortTable(${index})">
                  ${header} <span style="margin-left:5px; color:#666;">${arrow}</span>
                </th>`;
      });

      html += "</tr></thead><tbody>";

      data.forEach(row => {
        html += "<tr>";
        Object.values(row).forEach(val => {
          html += `<td>${val}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("table-container").innerHTML = html;
    }

    // Sorting function
    function sortTable(colIndex) {
      currentSortColumn = colIndex;
      sortDirection[colIndex] = !sortDirection[colIndex]; // toggle direction

      const header = Object.keys(tableData[0])[colIndex];

      const sorted = [...tableData].sort((a, b) => {
        let x = a[header];
        let y = b[header];

        // convert to numbers if possible
        let nx = parseFloat(x);
        let ny = parseFloat(y);
        if (!isNaN(nx) && !isNaN(ny)) { x = nx; y = ny; }

        return sortDirection[colIndex] ? x > y ? 1 : -1 : x < y ? 1 : -1;
      });

      renderTable(sorted);
    }

    // Search/filter functionality
     document.getElementById("search").addEventListener("input", function() {
      const filtered = tableData.filter(row =>
        Object.values(row).some(val =>
          String(val).toLowerCase().includes(this.value.toLowerCase())
        )
      );
      renderTable(filtered);
    });
  </script>
</body>
</html>